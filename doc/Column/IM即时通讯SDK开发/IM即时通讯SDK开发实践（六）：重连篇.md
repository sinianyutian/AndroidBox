# 重连策略

### 1、设计目的

+ TCP连接断开的时候需要进行重连
+ TCP连接数据传输有异常的时候需要进行断开再次重连

### 2、设计原则

+ 触发重连时最快速度的重连上TCP
+ 最合理的连接频率触发重连，避免过于频繁导致的功耗问题

### 3、重连方案

#### 3.1、触发重连的原因

由于设备网络、人为操作，我们无法保证24小时处于在线状态，但是我们可以检测到TCP连接出现异常时，通过重连保障TCP连接恢复正常。

+ 1、正常探测心跳超时

按照正常的心跳策略，发送心跳包超时，这时基本可以判定当前TCP通道已经断开，需要重连建立TCP连接。

+ 2、补发心跳超时

在进行业务请求时，发现请求超时，此刻有可能是网络延时，并不完全认定TCP网络断开，所以补发一个心跳包检测网络，发现还是超时，则重连。

+ 3、TCP连接中断

在数据交换过程中，因为网络问题而导致TCP中断，比如服务器关闭了这条连接，客户端抛出了SocketException或者是网络不稳定导致连接中断，此刻需要触发重连。

+ 4、网络连接广播

如果用户关闭了设备网络开关，再打开，此刻可以监听到系统的网络广播，如果此刻网络正常，则要触发重连。

+ 5、TLV数据解析异常

网络传输的数据如果在进行TLV协议解析时，出现了异常。极有可能这条TCP通道遭到了破坏，此刻进行重连，建立新的TCP通道。

+ 6、非连接态下的亮屏事件

这是一种保障性的操作，用户亮屏表示要使用APP，如果此刻设备网络正常，但是IM处于非连接状态，触发一次重连。

+ 7、连接失败重连

前面的是在TCP连接出现问题时触发了一次重连，如果连接失败，而此刻设备有网络，那么应该需要继续触发重连，直到连接成功。

#### 3.2、响应重连的策略

上述是重连的一些触发原因，但是我们不能直接就触发进行重连，必须要有针对性的策略来实现，避免功耗问题。我们为此分为五种模式：

+ 1、立即重连

适用于上述的（1），取消未完成的重连任务，5s后执行重连操作。

+ 2、网络问题重连

适用于2、3、7，进行逐步递增时间进行重连，其中2、3的最大时间为10min,7最大时间为20min。这里考虑到2、3间隔20min时间太长，所以进行区分对待。但是对于一直重连失败的情况，可以理解为当前的网络存在问题。那么时间长一点也是可以理解的。

+ 3、网络广播重连

如果当前有即将执行的重连，计算离当前连接时间，并与自身递增的时间比较

  - 若 即将执行的时间间隔 < 自身计算的时间，则忽略本次触发
  - 否则，cancel未执行重连任务，进行重连，间隔时间递增，最大3分钟

+ 4、TLV异常重连

取消未执行重连任务，进行重连，间隔时间递增，最大20分钟

+ 5、亮屏重连

适用于（6）、如果刚刚执行过的重连任务，且离当前时间间隔<3分钟,则忽略。否则，取消未执行的任务，进行重连，固定x分钟后进行重连。

#### 3.3、整体流程

![](https://github.com/zengjingfang/AndroidBox/blob/master/doc/Column/IM%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AFSDK%E5%BC%80%E5%8F%91/im_reconnect.jpg)


#### 3.4 设计细节

+ 当前的TCP连接时长大于3个短心跳，则可以表示重连成功后，前面一段时间内，网络是比较稳定的，如果再次触发重连，则应该清除掉之前的递增TAG，提高时效性。但是对于重连失败的触发，则不可这么做，会导致功耗问题。下面以具体场景来进行阐述：
	+ 场景1：上一次是递增到20min才连接成功，而后一段时间大约有7分钟是稳定的，在7分钟后断线了触发了重连机制，如果我们不把之前的TAG重置，则需要等待20min钟后才能真正的执行重连，时效性有所下降。
	+ 场景2：上一次TCP连接时长大于2个
+ 

### 4、域名管理

##### 4.1 域名、IP存储与淘汰

+ 来源：
	+ 本地写死默认的
	+ 服务器配置的通过HTTP请求获得
	+ LocalDns解析获得
	+ HttpDns解析获得

+ 存储

采用SQLite进行存储，由于同一个域名有多个ip，也同样存在不同端口。为了简便，我们用一个表来完成存储工作，所以需要用域名、IP地址、端口号三个字段来确定一条记录。

+ 淘汰

对于本地保存存储的IP，如果一直连接失败，那么就可怀疑设备连接这个ip的有效性，我们对每条域名记录的连接情况都有记录，如果连续失败5次，则淘汰删除本地存储的IP。其中，开始对于HttpDns解析得到的ip永远不做淘汰处理，但是服务端反馈如果在机房切换的情况下，存在IP地址变了的风险，虽然少之又少，但还是得考虑,所以，HttpDns解析的ip同样还是做淘汰处理。最终，只有存储到本地的域名永不删除。就是数据库中那个IP为null，域名和端口补位空的记录。

+ 优选

由于暂时服务器配置的ip不多，暂时仅采用轮询切换的策略，不过保留了后续扩展优化的余地。

##### 4.2 HttpDNS防劫持机制

+ 连接失败进行HttpDns解析

如果连接服务器失败，根据返回的异常进行判断一次，如果是认定的DNS异常，比如“SocketTimeoutException”、“UnknownHostException”、“ConnectException”（当然这种情况不一定就是发生了劫持），则就执行HttpDns解析的逻辑。

+ 连接中断进行HttpDns解析

这个是近期在云南地区移动网络发生的劫持特殊现象，和其他不同，劫持到了另外的IP，但是客户端能够连接成功，只是交换数据时直接中断并抛出自定义的“readlength = -1”的中断异常。如此，客户端反复的连接成功-中断-连接成功，一直没有连接失败的情况，一直无法跑到连接失败进行HttpDns解析的情况，所以对于这种情况进行特殊处理。

+ 尽量避免多余的HttpDns解析

HttpDns用的是第三方的付费服务，减少次数有利于节约成本。所以，在进行HttpDns解析之前要判断是否已经有了上一次的解析结果。如果有，则不重复走HttpDns。所以需要注意：当通过LocalDNS解析得到的IP不要覆盖掉HttpDns解析得到的IP。






