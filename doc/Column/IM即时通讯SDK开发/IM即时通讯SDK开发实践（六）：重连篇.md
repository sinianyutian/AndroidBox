# 重连策略

### 1、设计目的

+ TCP连接断开的时候需要进行重连
+ TCP连接数据传输有异常的时候需要进行断开再次重连

### 2、设计原则

+ 触发重连时最快速度的重连上TCP
+ 最合理的连接频率触发重连，避免过于频繁导致的功耗问题

### 3、重连方案

#### 3.1、触发重连的原因

由于设备网络、人为操作，我们无法保证24小时处于在线状态，但是我们可以检测到TCP连接出现异常时，通过重连保障TCP连接恢复正常。

+ 1、正常探测心跳超时

按照正常的心跳策略，发送心跳包超时，这时基本可以判定当前TCP通道已经断开，需要重连建立TCP连接。

+ 2、补发心跳超时

在进行业务请求时，发现请求超时，此刻有可能是网络延时，并不完全认定TCP网络断开，所以补发一个心跳包检测网络，发现还是超时，则重连。

+ 3、TCP连接中断

在数据交换过程中，因为网络问题而导致TCP中断，比如服务器关闭了这条连接，客户端抛出了SocketException或者是网络不稳定导致连接中断，此刻需要触发重连。

+ 4、网络连接广播

如果用户关闭了设备网络开关，再打开，此刻可以监听到系统的网络广播，如果此刻网络正常，则要触发重连。

+ 5、TLV数据解析异常

网络传输的数据如果在进行TLV协议解析时，出现了异常。极有可能这条TCP通道遭到了破坏，此刻进行重连，建立新的TCP通道。

+ 6、非连接态下的亮屏事件

这是一种保障性的操作，用户亮屏表示要使用APP，如果此刻设备网络正常，但是IM处于非连接状态，触发一次重连。

+ 7、连接失败重连

前面的是在TCP连接出现问题时触发了一次重连，如果连接失败，而此刻设备有网络，那么应该需要继续触发重连，直到连接成功。

#### 3.2、响应重连的策略

上述是重连的一些触发原因，但是我们不能直接就触发进行重连，必须要有针对性的策略来实现，避免功耗问题。我们为此分为五种模式：

+ 1、立即重连

适用于上述的（1），取消未完成的重连任务，5s后执行重连操作。

+ 2、网络问题重连

适用于2、3、7，进行逐步递增时间进行重连，其中2、3的最大时间为10min,7最大时间为20min。这里考虑到2、3间隔20min时间太长，所以进行区分对待。但是对于一直重连失败的情况，可以理解为当前的网络存在问题。那么时间长一点也是可以理解的。

+ 3、网络广播重连

如果当前有即将执行的重连，计算离当前连接时间，并与自身递增的时间比较

  - 若 即将执行的时间间隔 < 自身计算的时间，则忽略本次触发
  - 否则，cancel未执行重连任务，进行重连，间隔时间递增，最大3分钟

+ 4、TLV异常重连

取消未执行重连任务，进行重连，间隔时间递增，最大20分钟

+ 5、亮屏重连

适用于（6）、如果刚刚执行过的重连任务，且离当前时间间隔<3分钟,则忽略。否则，取消未执行的任务，进行重连，固定x分钟后进行重连。

#### 3.3、整体流程

![](https://github.com/zengjingfang/AndroidBox/blob/master/doc/Column/IM%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AFSDK%E5%BC%80%E5%8F%91/im_reconnect.jpg)


### 4、域名管理

##### 4.1 域名、IP存储与淘汰

##### 4.2 HttpDNS防劫持机制