### 一、简介

即时通讯，即Instant Messages,简称IM。是当前网络社会流行的通讯方式，可以实时传递文字、图片、视频等信息，我们每天都在享受这项技术带来的方便。非常有代表的就是我们每天使用的微信，QQ等社交产品。这些产品的背后都有一个核心部件在运作，暂且都称作IM SDK吧。经过一年多的开发维护，支撑着千万用户的聊天、消息通知、操作指令的需求，对IM的开发也算有一些经验，故总结成本系列文章，希望能够对应大家的开发学习有所帮助。特别感谢我的同事周俊华、刘鸿达在这个过程中的帮助，从中学习了许多IM相关的知识。鄙人才疏学浅，如果不当之处，欢迎批评指教。

### 二、关于SDK

IM作为一款基础性服务的SDK，和其他常用的SDK如行为采集、地图等一样，都是对外提供接口，对内实现某种复杂功能，具备某一特性并为APP业务起关键支撑作用。SDK的开发不同于业务APP的开发，它的需求相对稳定，对于操作系统的接口依赖相对较少。但是，SDK出现的每一个小问题都有可能导致APP业务出现故障，所以对于SDK的稳定性相对APP就有最高的要求。那么，如何做一款稳定可靠的SDK呢？本系列会单独列出一篇文章进行总结。

### 三、关于架构

曾经总结过关于APP的架构思考，去年至今在维护开发IM的SDK，经历了一次大的架构调整，重构了大部分的Push层的核心逻辑。一款优秀的SDK首先就要有一个合适的架构设计，合适在于适用于当前以及未来几年的业务。糟糕的架构或者没有架构的代码就是那种开始看起来简单、越写越复杂，再换几个人维护改几个Bug就陷入打补丁模式，而且出不来。好的架构可以让整体的业务逻辑更加清晰明了，修改一处不至于牵连全身。新增需求可以在原有基础上很自然的扩展，换了人维护也能够延续原有的框架，不至于弄的面貌全非，不至于弄成“写不下去”的代码。

### 四、关于协议

最初从同事那里刚接手IM的时候，觉得IM的原理其实很简单，就是发请求和接收响应。后面和同事的交流过程中，他告诉我Im最核心的地方是“协议”。大家可能都看过关于TCP/IP之类的书，书中也就一定提到“协议族”这个概念。的确，协议是通信的基础，是相互只见那沟通的“语言”规范。通信协议是一层层包装起来的，从物理层到应用层，到我们自研IM产品自定义的协议。协议要解决的一个问题，就是制定端到端之间的沟通约定。本系列也将讲述我们自研的协议基础。

### 五、关于心跳

“心跳”这两个字非常形象，它是维持TCP连接的重要手段，是IM开发的核心之一。心跳是什么呢？心跳就是客户端每隔一段时间发送一个”空包“给到服务端。为什么需要发一个没有用的“空包”呢？这里就涉及到网络传输中的一个问题。这个问题简称NAT(Network Address Translation),简单里说就是网络运营商发现一段时间某条连接没有使用就淘汰这条连接的IP地址对应表，这样的话这条TCP连接就实际上断开了。只是我们的客户端和服务端无法及时感知到。所以，心跳的目的有两个。第一，是不停的发送空包，不浪费流量的同时也保持了这条连接的活跃避免被淘汰。第二，是通过发包来检验这条TCP连接是否真正联通，如果发一个心跳包给到服务器但是无法收到服务的响应，那么可以判定这条TCP连接已经失效，需要重新建立连接。这也保障了IM的及时性。但是，以一个合理的频率发送心跳对于一款IM服务的SDK来说是非常重要的。

### 六、关于重连

我们都知到外面的网络环境是非常复杂的，尤其是我们的移动设备。如果网络存在问题，比如网络信号弱，网络频繁故障等等，对于一款即时通讯SDK来说，面对这些问题我们有什么好的解决方案呢？我想，对于上层应用开发者来讲，只有一个办法，那就是“重连”。重连的目的只有一个，就是发现TCP连接出现问题的时候以最快的速度重新连接。重连也需要讲究策略的，主要是两个方面。首先是，什么时候需要重连？也就是触发重连的时机。比如Android设备接收到网络广播时、心跳响应失败时、数据解析错误时等等。然后是，客户端连接哪个IP?所以，需要一套域名管理机制。最后，以什么样的频率重连？是发现断开时立即重连，还是等一会重连，这里我们针对不同的断线原因分别以不同的递增策略进行重连。

### 七、关键问题

前面大致说了协议、心跳、重连这三个核心内容，这是IM即时通讯SDK的三大核心部件。那么我们还需要许多的零部件串通起来，这个机器才能够正常的运转。首先，需要处理请求和响应的对应关系问题。网络传输过程中是复杂的，不可能保证一个请求发给服务端回来的就是对应的请求。接着，需要处理客户端身份ID的问题，我们该怎么定义一台设备？以及这台设备如何匹配登录的不同账户？最后，我们怎么保证发送的每条消息都能够送达到对方？处理好这些问题，才能够完整的开发出一款IM。

### 八、个人小结

这一年多的时间一直负责Android端的IM，曾经“自嘲”说，我只有一个Bug，那就是“又收不到了”。的确，这条TCP连接太脆弱了。网络环境的复杂导致了场景的复杂，在进行重构的过程中。真的是花了些时间在考虑设计、写代码、审代码，比起日常的业务迭代进度要缓和许多。但是也是经历了自测、测试测、众测才逐步趋于稳定，还有许多的问题需要通过大数据埋点来分析。网络环境的千变万化，增加的程序的复杂度，有许多的场景想不到，测不到。但是，还是潜藏了一些严重问题。还有就是，日常维护过程中有许多测试或者用户反馈“收不到消息”之类的问题，常常会打断工作的节奏，有些问题还需要花一些时间才能得出结论，需要的是耐心。解决一个，少一个。做一款稳定的SDK，很容易也很难。革命尚未成功，我还需努力。











  