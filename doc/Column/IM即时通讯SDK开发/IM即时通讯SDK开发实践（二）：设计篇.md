### 一、前言

任何一个软件工作的开发之初，都必须要有软件设计。这是体现“码农”和“工程师”区别的地方。我想软件的设计可以分为两种，一个是架构设计，另外一个是方案设计。架构的设计是相对概念上的，而方案设计则相对是具体细节的。架构设计好比一座大厦的框架，而方案设计就像房子的装修方案，水电铺排方案等。上一篇已经说到，SDK不比业务APP，SDK的需求相对稳定，而且不同的SDK特性所决定的技术特性也就不同，我们不可能简单的用APP开发中那些MVC或者MVP来套用。软件的架构就如建筑的框架，对于程序的稳定性、扩展性等等这一堆技术指标，架构起到了关键的作用。本篇就来大致的聊一聊IMSDK的设计。


### 二、关键需求

设计的第一个工作便是明确需求，需求只讨论要做什么？要解决哪些问题？而不讨论怎么实现。针对一款IM SDK 产品来讲，我觉得可以重点如下几个方面来讨论。

##### （1）、消息通道

这个是IM的基础工程，业务上有会话聊天、发送指令、发送推送消息的需求。所以需要的是一个双向的消息通道，而且能够随时发送或者接收消息。


#####（2）、身份标识

设备是不变的，但是同一台设备上可能会是不同的账号使用。所有，需要两个ID号的对应关系才能完整确定一个发送端或者接收端。

+ 机器标识：标记这台设备 

+ 账号标识：标记这台设备登录的账号


##### （3）、消息及时

作为即时通讯产品，发送消息能够及时接收是首要的。但是现有的网络环境以及终端设备并不能直接满足这个需求，不能保证一条TCP通道是24小时联通的。这里存在许多外界环境的干扰：

+ 第一，受到基础设施的影响，比如NAT的问题、服务器能力。
+ 第二，受终端设备环境的影响，比如终端进入了一个无网络或者网络信号弱不稳定的环境。
+ 第三，受终端设备操作系统的影响，比如android的后台进程强杀机制。
+ 第三，受用户行为的影响，设备欠费、关闭网络、退出程序、关闭应用。

日常使用即时通讯产品的时候，延迟个一两秒的时间就有些不赖烦了。所以，为了能够消息及时，必须针对这些问题作出相应的解决方案，想方设法让消息能够随时发送出去，也同样能够随时接收到外部发送过来的消息。

##### （4）、消息可靠

什么叫消息可靠，我想可靠就是发了什么，对方就能收到什么。可以从下面两个方面进行讨论：

+ 消息不丢失：消息从A端发送给B端，A端能知道自己是发送成功or失败，但是B端是收到还是没收到了呢？所以，不仅要解决发送的问题，还需要确认对方是否收到的问题。

+ 消息内容安全：网络那些乱七八糟的攻击技术之类的就不说了，对发送消息内容进行一定的加密还是很有必要的，毕竟通过IM传输的许多都是敏感信息。

##### （5）、性能优良

即时通讯要求的是24小时能够随时随地的进行消息的发送和接收。我想可以从如下进行讨论：

+ 速度

消息的接收发送延迟少、消息通道出现异常能够迅速恢复；

+ 功耗

性能中最重要的便是对功耗的影响，尤其是我们的手表设备中。电池容量小，待机时间要求长。但是，TCP长连接需要心跳、重连机制来维持，那么他们的频率要设计合理；


##### （6）、运行稳定

什么叫稳定？那就是在用户手上正常运行。想要做到这些，除了编程时优良的设计，还需要线上版本实时的监控。

+ 崩溃

曾经因为一个高概率随机出现一个崩溃异常导致版本不能正常发出，程序崩溃是表现稳定性最直观的东西。

+ 大数据监控

没有崩溃并不代表真的运行正常，心跳正常吗？重连正常吗？IM一直在线吗？这些都可以通过大数据埋点进行监控分析。经验表明，有许多潜在问题用户并没有反馈出来，但是我们可以通过大数据分析得出并优化。这是赶在用户投诉前进行处理。

### 三、架构设计


#### 1、定义


+ 组成派：“软件系统的架构将系统描述为计算组件及组件之间的交互”，也就是说架构就是将一个软件系统分离成不同的组件，组件与组件之间通过相互通信完成更高层次的运算。这是以“软件”本身的角度来定义架构。

+ 决策派：软件架构是一些重要方面所作出的决策的集合。软件架构不仅关注软件本身的结构和行为，还需要关注其他特性，如使用、功能性、性能、弹性、美学等等。这是以“人”的角度来定义架构。

上述内容引自温昱的《软件架构设计》一书，我的理解是从“软件”本身来看，架构就是将一个复杂的软件系统拆分成若干个组件，并给组件间建立好通信机制。组件内部处理好自己的业务，并对外公开接口来实现通信。但是从“人”的角度来看，我们在对一个程序系统进行设计时，需要了解各方的需求、权衡许多内在的、外在的因素，并针对每个问题作出一系列的决策集。


#### 2、整体架构

针对现有的需求，我们设计了IM的整体架构：

![](http://ww1.sinaimg.cn/large/aea705afgy1frwweasa4zj20hr0k5gm1.jpg)

我们整个的IM SDK 分为3个module工程来开发，分别是图中间的IMPhone、IMWatch,以及图底下的IMCore。IMPhone 和 IMWatch 主要是针对性的对手机和手表做些不同的特性处理。最顶上的可以看到两个Demo来调试我们的SDK。

重点说下IMCore，这个整个IM的核心。整体的结构分为两层，APP进程和Push进程层。App进程主要对外提供接口，并且处理和业务的事情。Push进程是单独为IM开的一个进程，主要是维持这条消息通道、并且对消息内容按照定义好的TLV协议进行处理。

#### 3、关键决策

在进行设计过程中，我们团队针对一些问题进行了讨论。有许多大大小小的决策融于过程中，列举几个决策如下：

##### （1）、是否存在宿主共享需求

宿主共享是多个APP需要集成IM服务时。只有其中一个App的Push进程在真正意义上的工作，其他APP的集成的IM仅跑APP进程的逻辑，绑定的是宿主APP的同一个Push服务。这么做的目的是，多个APP共享一个IM核心服务，共用一条TCP长连接。这样节约资源，APP迭代灵活。作为手机端来讲，我们只有一个APP。这个需求几乎不存在，但是在手表端，存在多个App需要IM服务。而且这种潜在需求会一直增长。但是，最后决定不做这个功能。因为，首先，当年以及未来几年内这个需求不会很强烈。而且，需求处理这个问题涉及到多进程等诸多方面的处理，复杂度高。所以，最后仅在设计时留有余地，保证未来的可扩展性。

##### （2）、账号管理应该放在哪个进程处理

这个问题反复了许多次，最后在开发中才定下来。账号管理业务要处理的事情是账号上下线，这个从实际的业务区别来看。这个应该是属于APP层的业务，因为他是APP的行为。但是，我们考虑到目前业务中还没有存在一个设备多个账号同时存在的情况。将它归为Push进程来处理也不是不可以，这样做可以降低复杂度。但是真正完成开发后，才发现APP层的业务对于账号的数据状态存在依赖。跨进程获取存在不可靠因素、两个进程同时保持数据存在同步数据的麻烦。最后，还是决定放到APP层来处理。


### 四、方案设计

这里介绍下针对IM的复杂性而设计的两个方案，通过合适的设计模式以及仿造开源框架简化问题。

#### 1、状态模式应用

IM的复杂性主要在于网络的不稳定，导致用户的场景一直在变化，还有各种临界问题不好处理。基于这些，我们引入了“状态模式”，我们也直接称之为“状态机”。主要应用在心跳模块和基础模块，在重连模块中的第一阶段相对简单，所以没有应用。后期的开发如果要更进一步优化如夜间模式、短信模式等也可转变为一个“状态机”。整个Push服务就像一个永动机一样，只要启动了服务。随时可以应对外部的变化，在不同状态下做自己该干的事情。而且不同的状态机之间的相互隔离，降低了耦合性。


![](http://ww1.sinaimg.cn/large/aea705afgy1frwyw519qmj20to0l4t9x.jpg)

###### PushState（Push状态机，负责im的设备注册登录管理）


+ 1. Event输入事件：tcp的连接状态（成功或者失败输入）
+ 2. Event输入事件：重连闹钟的执行TCP重连指令
+ 3. Action输出事件： 执行或者取消TCP连接
+ 9、Event输入事件：亮屏、网络广播等系统事件


###### HeartBeat (心跳状态机，负责Im的心跳管理)


+ 4、Action输出事件：心跳失败导致的tcp断线、心跳成功驱动ConnectState检测是否进入短信模式
+ 5、Event输入事件： TCP连接成功会启动心跳（这里待商量，是不是在进入Login态的时候再启动心跳）
+ 10、Event输入事件：亮屏、网络广播等系统事件（暂时没有启用）


####### ConnectState(连接状态机，负责tcp的连接管理)


+ 6、Event输入事件：收到短信会退出短信模式
+ 7、Action输出事件：根据策略计划重连任务，开启闹钟
+ 8、Action输出事件：执行、取消、断开TCP连接


#### 2、请求响应通信框架

IM开发过程中，还有个比较麻烦的事情，那就是请求和响应的处理，以及跨进程通信的问题。为此，我们仿照了OkHttp的请求响应框架，进行了一定的改造。在前面的架构图中可以看到：

+ TCPTask: 每

+ AidlTask： 

App业务端往往需要调用Push进程接口完成操作，这里是跨进程的。项目中，我们是通过绑定service实现。但是，接口的调用怎么保证成功了呢。这里，我们直接将APP看成客户端、Push进程看成服务端。使用类似的请求响应来进行处理。


### 五、过程中设计

这里聊一聊在进行设计中的一个经验和体会，那就是在过程中设计。当我们一本正经的来思考我们该怎么进行设计时，总还是感觉想不清楚。这个时候，可以选择敲几行代码。设计也是在实现过程中，不断摸索不断完善的。

+  先整体后局部，如IM的SDK开发中，首先我们知道要分为APP层和push层两个进程，Push层属于im的核心业务，需要管理TCP的连接，协议，设备注册登录等。App层需要处理业务相关的逻辑，如对外提供接口，消息转发处理等。那么整体的一个程序架构图、各个组件间怎么进行通信交互基本心中有数。
  
+  确定关键性问题，首先对项目的整体有一个全局性的把握，并分析出完成开发需要解决的关键性问题，以及一些难点问题。比如，重构后我们通过请求响应框架解决了请求响应处理的问题。

+  编码中调整，有些设计在实时过程中发现是不合理的，那就在就如上面提到的账号管理的决策过程，每一次讨论都有当前认知情况下的利弊权衡，并进行调整。

+  简化问题的好处，想必很多项目中都碰到一个难点，就是多线程的处理。那么在重构之后，我们统一了部分程序调用的入口，并让他们都跑在一个Handler线程上，从而规避了线程处理的复杂性。逻辑简单了，维护起来也方便。




