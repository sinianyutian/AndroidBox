### 一、前言

任何一个软件工作的开发之初，都必须要有软件设计。这是体现“码农”和“工程师”区别的地方。我想软件的设计可以分为两种，一个是架构设计，另外一个是方案设计。架构的设计是相对概念上的，而方案设计则相对是具体细节的。架构设计好比一座大厦的框架，而方案设计就像房子的装修方案，水电铺排方案等。上一篇已经说到，SDK不比业务APP，SDK的需求相对稳定，而且不同的SDK特性所决定的技术特性也就不同，我们不可能简单的用APP开发中那些MVC或者MVP来套用。软件的架构就如建筑的框架，对于程序的稳定性、扩展性等等这一堆技术指标，架构起到了关键的作用。本篇就来大致的聊一聊IMSDK的设计。


### 二、关键需求

设计的第一个工作便是明确需求，需求只讨论要做什么？会有什么问题？而不讨论怎么实现。针对一款IM SDK 产品来讲，我觉得可以重点如下几个方面来讨论。

###### （1）、消息通道

这个是IM的基础工程，业务上有会话聊天、发送指令、发送推送消息的需求。所以需要的是一个双向的消息通道，而且能够随时发送或者接收消息。


###### （2）、身份标识

设备是不变的，但是同一台设备上可能会是不同的账号使用。所有，需要两个ID号的对应关系才能完整确定一个发送端或者接收端。

+ 机器标识：标记这台设备 

+ 账号标识：标记这台设备登录的账号


###### （3）、消息及时

作为即时通讯产品，发送消息能够及时接收是首要的。但是现有的网络环境以及终端设备并不能直接满足这个需求，不能保证一条TCP通道是24小时联通的。这里存在许多外界环境的干扰：

+ 第一，受到基础设施的影响，比如NAT的问题、服务器能力。
+ 第二，受终端设备环境的影响，比如终端进入了一个无网络或者网络信号弱不稳定的环境。
+ 第三，受终端设备操作系统的影响，比如android的后台进程强杀机制。
+ 第三，受用户行为的影响，设备欠费、关闭网络、退出程序、关闭应用。

日常使用即时通讯产品的时候，延迟个一两秒的时间就有些不赖烦了。所以，为了能够消息及时，必须针对这些问题作出相应的解决方案，想方设法让消息能够随时发送出去，也同样能够随时接收到外部发送过来的消息。

###### （4）、消息可靠

什么叫消息可靠，我想可靠就是发了什么，对方就能收到什么。可以从下面两个方面进行讨论：

+ 消息不丢失：消息从A端发送给B端，A端能知道自己是发送成功or失败，但是B端是收到还是没收到了呢？所以，不仅要解决发送的问题，还需要确认对方是否收到的问题。

+ 消息内容安全：网络那些乱七八糟的攻击技术之类的就不说了，对发送消息内容进行一定的加密还是很有必要的，毕竟通过IM传输的许多都是敏感信息。

###### （5）、性能优良

即时通讯要求的是24小时能够随时随地的进行消息的发送和接收。我想可以从如下进行讨论：

+ 功耗

性能中最重要的便是对功耗的影响，尤其是我们的手表设备中。电池容量小，待机时间要求长。但是，TCP长连接需要心跳、重连机制来维持，那么他们的频率要设计合理；

+ 资源


###### （6）、运行稳定



### 三、架构设计


#### 1、定义


+ 组成派：“软件系统的架构将系统描述为计算组件及组件之间的交互”，也就是说架构就是将一个软件系统分离成不同的组件，组件与组件之间通过相互通信完成更高层次的运算。这是以“软件”本身的角度来定义架构。

+ 决策派：软件架构是一些重要方面所作出的决策的集合。软件架构不仅关注软件本身的结构和行为，还需要关注其他特性，如使用、功能性、性能、弹性、美学等等。这是以“人”的角度来定义架构。

上述内容引自温昱的《软件架构设计》一书，我的理解是从“软件”本身来看，架构就是将一个复杂的软件系统拆分成若干个组件，并给组件间建立好通信机制。组件内部处理好自己的业务，并对外公开接口来实现通信。但是从“人”的角度来看，我们在对一个程序系统进行设计时，需要了解各方的需求、权衡许多内在的、外在的因素，并针对每个问题作出一系列的决策集。


#### 2、整体架构
  
#### 3、组件介绍

#### 4、关键决策


### 四、方案设计

#### 1、状态模式应用

#### 2、请求响应框架



### 五、过程中设计


#### 1、先整体后局部


#### 2、编码中调整


#### 3、简化问题的好处




