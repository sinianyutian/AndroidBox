### 一、前言

前面已经提到过，心跳是为了维持一条TCP通道能够持续的处理联通状态，保证消息能够实时接收和发送。但是，频繁的心跳会带来功耗问题。所以业界产生了智能心跳方案，我们团队也曾探索过多种方案，目前还是以[“Android微信智能心跳方案”](https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&mid=207243549&idx=1&sn=4ebe4beb8123f1b5ab58810ac8bc5994)一文中介绍为主要参考，实现我们心跳方案。本篇将对心跳方案进行详细的介绍。

### 

### 二、设计原则

+ 最大限度的接近NAT时间
+ 最快速度探测到稳定心跳
+ 心跳失败时，需要触发重连
+ 以最合适的心跳频率，最少的心跳次数，维持TCP长连接

### 三、设计方案

#### 1、整体设计（基于状态模式）
+ 1、IdleState：初始状态

当心跳处在这个态时，说明此刻IM是属于离线状态。这是程序的初始状态，同样如果在别的状态如果心跳响应失败或者TCP连接中断，就会切到这个状态。在这个状态时，只有等待TCP再次连接上，才会切换到LowActive或者Active态，由此开启了心跳程序。

+ 2、LowActiveState:次活跃态

即应用处于后台或者息屏，固定短心跳维持连接。超过三个短心跳表示当前TCP连接稳定，切换到Adaptive态进行自适应探测。为什么需要短心跳，这是为了保障网络在稳定状态下进行心跳的探测，这样探测的值更准确。


+ 3、ActiveState:活跃态

当前应用处于前台或者息屏，此时应该用户在使用尽量保持连接稳定，已当前探测的心跳维持连接。

+ 4、AdaptiveState:自适应态

当前处于后台且息屏，首先以“长步长”探测，然后以“短步长”探测，逐步逼近NAT过期时间。

+ 5、StableState:稳定态：

探测到稳定心跳后，会进入稳定态，已稳定心跳维持TCP连接。若稳定心跳连续失败5次，则清除探测记录重新探测。

> 探测心跳状态之间的切换如图：

![](http://172.28.1.116:9999/Task/AndroidWatch/uploads/ca14d1afcf491b1be0f126ccce48261c/heartbeat-state.png)

#### 2、细节设计


##### （1）、心跳探测方案的设计

心跳探测的目的是为了通过一定策略动态调整心跳频率，网络环境不同，那个NAT的值是不确定的，到底多长时间探测一次合适呢？对于性能要求不高的情况还好，我们的IM是需要跑在一款手表上的，心跳过低直接带来功耗问题，没几天就用户投诉过来了。中间，我们团队探索过其他的方案，目前我们还是参考微信智能心跳方案进行设计。

+ 心跳探测策略
	+ 当设备登录成功后，再激活整个心跳程序开启探测。
	+ 网络稳定性的验证，每次断线重连后都要经过固定个数的短心跳，也就是上图中的LowActivieSate(次活跃态)的过程，才能进入探测态进行探测。
	+ 探测步长策略：先长步长探测，后短步长探测
+ 心跳探测边界条件
	+ 不能超出最大或者最小心跳
	+ 连续失败次数超过配置的次数（默认5次）
	+ 长步长达到条件则退回1个步长，进入短步长探测
	+ 短步长达到条件则减小一个临界值，并进入稳定心跳

![](https://docs.google.com/drawings/d/e/2PACX-1vSLLt4dwZOH3NS0fDkmak7-Q9sV4CWd0BdDCMG-uKKrhhE6Xwmcwp-ojJaBfjsr9n5TUOSEXkfMVZ8b/pub?w=369&h=224)

##### （2）、心跳配置管理

根据上述的方案，我们有一些配置参数。分别是：

+ 网络标记：标记当前探测的网络，如果是数据流量，那基本是移动XX、联通XX,如果是wifi，就有千奇百怪的名字。所以，我们以网络标识作为某一个用户对于某一种网络下的探测配置的“主键”，他代表了当前网络类型的心跳探测配置。这是心跳进行探测的重要参数。可在本地默认一份，服务器配置一份，这样可以在服务器进行动态配置。

+ 最小心跳：最短的心跳时长
+ 最大心跳：最长的心跳时长
+ 当前心跳：默认心跳时长的起始值
+ 短步长：接近NAT值细调的步长
+ 长步长：开始探测时的大步递增探测
+ 稳定心跳时长：探测到稳定心跳后保持的时长

##### （3）、心跳记录管理
在探测过程中，网络随时可变，所以我们需要将探测的数据持久化。我们记录了如下参数：

+ 网络标记： 和心跳配置的网络标记进行匹配，也是心跳记录的“主键”
+ 当前心跳： 当前探测的心跳值
+ 是否短步长：是否已完成长步长探测  false 长步长探测，true 短步长探测
+ 是否稳定：当前网络的NAT探测是否达到稳定态
+ 当前网络长步进值连续失败的次数
+ 当前网络短步进值连续失败次数
+ 稳定心跳的失效日期，超过该时间后，将再次触发心跳探测

##### （4）、特殊情况处理

+ 业务响应重置心跳
	
在心跳探测过程中，假如我们有其他的业务请求响应回来。这个时候，我们该如何应对呢？比如，我们在本来心跳探测时5分钟后的，在等待了2分钟后，来了一个业务响应，如果我们还是以之前的5分钟也就是当前时间3分钟后响应心跳，这明显是会造成误探测的。因为一旦有数据走了TCP这条通道，就表示TCP活跃了一次。NAT时间也会重新计算。此刻，我们应该重置心跳时间，从当前开始下一个5分钟发出心跳请求。这个问题在其他状态下也需要重置心跳时间，能够减少不必要的心跳次数。

+ 网络变化切换状态

有这么一种情况，数据网络从4G切到2G时，应用层感知不到，TCP连接不会断开。因此在上调心跳值时，需要判断网络是否发生变化，如果发生变化，需要从新回到次活跃态，进行网络稳定性检测，使用新的网络类型的探测信息进行探测。

+ 补发心跳网络检查

如果我们在进行业务请求时，发现请求超时失败了。那该怎么办呢？如果仅仅只是网络的延迟导致，那么立即断开进行重连就显得有些“浪费"了，为此，我们设计了一个补发心跳的机制。在这种情况下，我们先发送一个心跳，如果心跳响应也超时了。那么我们就认定，网络真的不行了。这是进行网络是否有效的一种检测。

### 四、参考资料
[Android微信智能心跳方案](https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&mid=207243549&idx=1&sn=4ebe4beb8123f1b5ab58810ac8bc5994)