### 一、前言

前面已经提到过，心跳是为了维持一条TCP通道能够持续的处理联通状态，保证消息能够实时接收和发送。但是，频繁的心跳会带来功耗问题。所以业界产生了智能心跳方案，我们团队也曾探索过多种方案，目前还是以[“Android微信智能心跳方案”](https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&mid=207243549&idx=1&sn=4ebe4beb8123f1b5ab58810ac8bc5994)一文中介绍为主要参考，实现我们心跳方案。本篇将对心跳方案进行详细的介绍。

### 

### 二、设计原则

+ 最大限度的接近NAT时间
+ 最快速度探测到稳定心跳
+ 心跳失败时，需要触发重连
+ 以最合适的心跳频率，最少的心跳次数，维持TCP长连接

### 三、设计方案

#### 1、整体设计（基于状态模式）
+ 1、IdleState：初始状态

当心跳处在这个态时，说明此刻IM是属于离线状态。这是程序的初始状态，同样如果在别的状态如果心跳响应失败或者TCP连接中断，就会切到这个状态。在这个状态时，只有等待TCP再次连接上，才会切换到LowActive或者Active态，由此开启了心跳程序。

+ 2、LowActiveState:次活跃态

即应用处于后台或者息屏，固定短心跳维持连接。超过三个短心跳表示当前TCP连接稳定，切换到Adaptive态进行自适应探测。为什么需要短心跳，这是为了保障网络在稳定状态下进行心跳的探测，这样探测的值更准确。


+ 3、ActiveState:活跃态

当前应用处于前台或者息屏，此时应该用户在使用尽量保持连接稳定，已当前探测的心跳维持连接。

+ 4、AdaptiveState:自适应态

当前处于后台且息屏，首先以“长步长”探测，然后以“短步长”探测，逐步逼近NAT过期时间。

+ 5、StableState:稳定态：

探测到稳定心跳后，会进入稳定态，已稳定心跳维持TCP连接。若稳定心跳连续失败5次，则清除探测记录重新探测。

> 探测心跳状态之间的切换如图：

![](http://172.28.1.116:9999/Task/AndroidWatch/uploads/ca14d1afcf491b1be0f126ccce48261c/heartbeat-state.png)

#### 2、细节设计

+ 心跳探测策略
	+ 先长步长探测，后短步长探测
+ 心跳探测边界条件
	+ 不能超出最大或者最小心跳
	+ 连续失败次数超过配置的次数
	+ 长步长达到条件则退回两个步长，进入短步长探测
	+ 短步长达到条件则减小一个临界值，并进入稳定心跳

![](https://docs.google.com/drawings/d/e/2PACX-1vSLLt4dwZOH3NS0fDkmak7-Q9sV4CWd0BdDCMG-uKKrhhE6Xwmcwp-ojJaBfjsr9n5TUOSEXkfMVZ8b/pub?w=369&h=224)

+ 冗余心跳
	+ 普通的业务数据请求失败会补发一个心跳


### 四、参考资料
[Android微信智能心跳方案](https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&mid=207243549&idx=1&sn=4ebe4beb8123f1b5ab58810ac8bc5994)